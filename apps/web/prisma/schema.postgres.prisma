generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  USER
  ADMIN
  SUPERUSER
}

enum Plan {
  FREE
  PRO
}

enum PlanStatus {
  ACTIVE
  PAUSED
  SUSPENDED
}

enum TaskStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum UsageType {
  GENERATION
  FOLLOWUP
  IMAGE
  VISUALIZATION
}

enum FeatureFlagScope {
  GLOBAL
  USER
  ROLE
}

model User {
  id               String    @id @default(cuid())
  firstName        String
  lastName         String
  workDescription  String?
  email            String    @unique
  passwordHash     String
  emailVerifiedAt  DateTime?
  role             UserRole  @default(USER)
  plan             Plan      @default(FREE)
  planStatus       PlanStatus @default(ACTIVE)
  stripeCustomerId String?
  generationLimit  Int?
  lastLoginAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  deletedById      String?

  sessions               Session[]
  oauthAccounts          OAuthAccount[]
  emailVerifications     EmailVerification[]
  passwordResets         PasswordReset[]
  projects               Project[]
  tasks                  Task[]
  taskTemplates          TaskTemplate[] @relation("TemplateCreator")
  billingEvents          BillingEvent[]
  usageLedger            UsageLedger[]
  historyEntries         HistoryEntry[]
  apiKeys                ApiKey[]
  supportRequests        SupportRequest[]
  feedbacks              Feedback[]
  recommendationFeedbacks RecommendationFeedback[]
}

model OAuthAccount {
  id                 String   @id @default(cuid())
  provider           String
  providerAccountId  String
  email              String?
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash  String    @unique
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model SupportRequest {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  firstName   String
  lastName    String
  email       String
  message     String   @db.Text
  phone       String?
  requestType String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

model Feedback {
  id           String   @id @default(cuid())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  type         String
  message      String   @db.Text
  source       String?
  triggerCount Int?
  taskId       String?
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
  @@index([type])
}

model EmailVerification {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

model Project {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  sortOrder   Int      @default(0)
  description String?  @db.Text
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tasks   Task[]
  history HistoryEntry[]

  @@index([userId])
}

model HistoryEntry {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectId     String?
  project       Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  title         String
  content       String   @db.Text
  templateIndex Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  recommendationFeedbacks RecommendationFeedback[]

  @@index([userId])
  @@index([projectId])
  @@index([createdAt])
}

model RecommendationFeedback {
  id                String       @id @default(cuid())
  userId            String
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  historyEntryId    String
  historyEntry      HistoryEntry @relation(fields: [historyEntryId], references: [id], onDelete: Cascade)
  recommendationNum Int
  feedback          String
  templateId        String?
  templateTitle     String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@unique([userId, historyEntryId, recommendationNum])
  @@index([userId])
  @@index([historyEntryId])
  @@index([createdAt])
}

model TaskTemplate {
  id                    String   @id @default(cuid())
  category              String
  subcategory           String
  title                 String
  guidanceUseAiTo       String?  @db.Text
  guidanceExample       String?  @db.Text
  guidanceOutcome       String?  @db.Text
  prompt                String   @db.Text
  assets                String?  @db.Text
  allowedModes          String[]
  allowedModels         String[]
  allowUrlInput         Boolean  @default(false)
  allowFileUploads      Boolean  @default(true)
  allowMockupGeneration Boolean  @default(true)
  allowRefineAnalysis   Boolean  @default(true)
  allowWireframeRenderer Boolean @default(false)
  isActive              Boolean  @default(true)
  templateCategoryId    String?
  templateCategory      TemplateCategory? @relation(fields: [templateCategoryId], references: [id], onDelete: SetNull)
  createdById           String?
  createdBy             User?    @relation("TemplateCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tasks Task[]

  @@index([isActive, category, title])
  @@index([templateCategoryId])
}

model TemplateCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates TaskTemplate[]
}

model PaymentConfig {
  id        String   @id @default(cuid())
  pricePro  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Task {
  id              String        @id @default(cuid())
  projectId       String?
  project         Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  templateId      String?
  template        TaskTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  prompt          String        @db.Text
  mode            String
  model           String
  status          TaskStatus    @default(PENDING)
  response        Json?
  error           String?       @db.Text
  contextThreadId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  assets                 TaskAsset[]
  ledgerEntries          UsageLedger[]
  visualizationArtifacts VisualizationArtifact[]

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([templateId])
  @@index([projectId])
}

model TaskAsset {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  filename    String
  mimeType    String
  sizeBytes   Int
  storagePath String
  createdAt   DateTime @default(now())

  @@index([taskId])
}

model VisualizationArtifact {
  id               String   @id @default(cuid())
  taskId           String
  task             Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  sectionId        String?  // identifies the section within the task output
  sectionType      String?  // e.g. assumption_inventory, risk_summary, mitigation_plan
  enforcementLevel String   @default("ALLOWED") // ALLOWED | FORCED | CONDITIONAL
  templateId       String?  // e.g. heatmap_v1, matrix_v1, exec_card_v1
  format           String   @default("png")
  width            Int?
  height           Int?
  storageUrl       String?  @db.Text
  imageData        String?  @db.Text // base64-encoded PNG for inline storage
  inputHash        String?  // hash of section JSON; used for cache
  status           String   @default("rendered") // queued | rendered | failed
  createdByModel   String?  // model used to generate if AI-assisted
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([taskId])
  @@index([inputHash])
  @@index([status])
}

model UsageLedger {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskId          String?
  task            Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)
  type            UsageType
  costEstimateUsd Float?
  tokensIn        Int?
  tokensOut       Int?
  model           String?
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([taskId])
  @@index([createdAt])
}

model BillingEvent {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  stripeEventId String   @unique
  type          String
  data          Json
  createdAt     DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
}

model FeatureFlag {
  key       String           @id
  scope     FeatureFlagScope
  value     Json
  userId    String?
  role      UserRole?
  createdAt DateTime         @default(now())
}

model PlanConfig {
  id         String   @id @default(cuid())
  plan       Plan     @unique
  dailyLimit Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model ApiKey {
  id          String   @id @default(cuid())
  provider    String
  displayName String
  key         String
  isActive    Boolean  @default(true)
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([provider, isActive])
  @@index([createdById])
}

model PromoSignup {
  id              String    @id @default(cuid())
  firstName       String
  lastName        String
  email           String    @unique
  yearsExperience String
  status          String    @default("PENDING")
  activatedAt     DateTime?
  expiresAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([status])
  @@index([email])
}
