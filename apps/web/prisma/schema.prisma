generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model ApiKey {
  id          String   @id
  provider    String
  displayName String
  key         String
  isActive    Boolean  @default(true)
  createdById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  User        User?    @relation(fields: [createdById], references: [id])

  @@index([createdById])
  @@index([provider, isActive])
}

model BillingEvent {
  id            String   @id
  userId        String?
  stripeEventId String   @unique
  type          String
  data          Json
  createdAt     DateTime @default(now())
  User          User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
}

model EmailVerification {
  id        String    @id
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model FeatureFlag {
  key       String           @id
  scope     FeatureFlagScope
  value     Json
  userId    String?
  role      UserRole?
  createdAt DateTime         @default(now())
}

model Feedback {
  id           String   @id
  userId       String?
  type         String
  message      String
  source       String?
  triggerCount Int?
  taskId       String?
  createdAt    DateTime @default(now())
  User         User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([type])
  @@index([userId])
}

model HistoryEntry {
  id                     String                   @id
  userId                 String
  projectId              String?
  title                  String
  content                String
  templateIndex          Int?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  Project                Project?                 @relation(fields: [projectId], references: [id])
  User                   User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  RecommendationFeedback RecommendationFeedback[]

  @@index([createdAt])
  @@index([projectId])
  @@index([userId])
}

model OAuthAccount {
  id                String   @id
  provider          String
  providerAccountId String
  email             String?
  userId            String
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([provider, providerAccountId])
  @@index([userId])
}

model PasswordReset {
  id        String    @id
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PaymentConfig {
  id        String   @id
  pricePro  String?
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model PlanConfig {
  id         String   @id
  plan       Plan     @unique
  dailyLimit Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime
}

model Project {
  id           String         @id
  userId       String
  name         String
  sortOrder    Int            @default(0)
  description  String?
  metadata     Json?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  HistoryEntry HistoryEntry[]
  User         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  Task         Task[]

  @@index([userId])
}

model PromoSignup {
  id              String    @id
  firstName       String
  lastName        String
  email           String    @unique
  yearsExperience String
  status          String    @default("PENDING")
  activatedAt     DateTime?
  expiresAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime

  @@index([email])
  @@index([status])
}

model RecommendationFeedback {
  id                String       @id
  userId            String
  historyEntryId    String
  recommendationNum Int
  feedback          String
  templateId        String?
  templateTitle     String?
  createdAt         DateTime     @default(now())
  updatedAt         DateTime
  HistoryEntry      HistoryEntry @relation(fields: [historyEntryId], references: [id], onDelete: Cascade)
  User              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, historyEntryId, recommendationNum])
  @@index([createdAt])
  @@index([historyEntryId])
  @@index([userId])
}

model Session {
  id        String    @id
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime  @default(now())
  User      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
  @@index([userId])
}

model SupportRequest {
  id          String   @id
  userId      String?
  firstName   String
  lastName    String
  email       String
  message     String
  phone       String?
  requestType String?
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
}

model Task {
  id              String        @id
  projectId       String?
  userId          String
  templateId      String?
  prompt          String
  mode            String
  model           String
  status          TaskStatus    @default(PENDING)
  response        Json?
  error           String?
  contextThreadId String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  Project         Project?      @relation(fields: [projectId], references: [id])
  TaskTemplate    TaskTemplate? @relation(fields: [templateId], references: [id])
  User            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  TaskAsset       TaskAsset[]
  UsageLedger     UsageLedger[]

  @@index([projectId])
  @@index([status, createdAt])
  @@index([templateId])
  @@index([userId, createdAt])
}

model TaskAsset {
  id          String   @id
  taskId      String
  filename    String
  mimeType    String
  sizeBytes   Int
  storagePath String
  createdAt   DateTime @default(now())
  Task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model TaskTemplate {
  id                    String            @id
  category              String
  subcategory           String
  title                 String
  guidanceUseAiTo       String?
  guidanceExample       String?
  guidanceOutcome       String?
  prompt                String
  assets                String?
  allowedModes          String[]
  allowedModels         String[]
  allowUrlInput         Boolean           @default(false)
  allowFileUploads      Boolean           @default(true)
  allowMockupGeneration Boolean           @default(true)
  allowRefineAnalysis   Boolean           @default(true)
  isActive              Boolean           @default(true)
  templateCategoryId    String?
  createdById           String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime
  Task                  Task[]
  User                  User?             @relation(fields: [createdById], references: [id])
  TemplateCategory      TemplateCategory? @relation(fields: [templateCategoryId], references: [id])

  @@index([isActive, category, title])
  @@index([templateCategoryId])
}

model TemplateCategory {
  id           String         @id
  name         String         @unique
  sortOrder    Int            @default(0)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime
  TaskTemplate TaskTemplate[]
}

model UsageLedger {
  id              String    @id
  userId          String
  taskId          String?
  type            UsageType
  costEstimateUsd Float?
  tokensIn        Int?
  tokensOut       Int?
  model           String?
  createdAt       DateTime  @default(now())
  Task            Task?     @relation(fields: [taskId], references: [id])
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([taskId])
  @@index([userId])
}

model User {
  id                     String                   @id
  firstName              String
  lastName               String
  workDescription        String?
  email                  String                   @unique
  passwordHash           String
  emailVerifiedAt        DateTime?
  role                   UserRole                 @default(USER)
  plan                   Plan                     @default(FREE)
  planStatus             PlanStatus               @default(ACTIVE)
  stripeCustomerId       String?
  generationLimit        Int?
  lastLoginAt            DateTime?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  deletedAt              DateTime?
  deletedById            String?
  ApiKey                 ApiKey[]
  BillingEvent           BillingEvent[]
  EmailVerification      EmailVerification[]
  Feedback               Feedback[]
  HistoryEntry           HistoryEntry[]
  OAuthAccount           OAuthAccount[]
  PasswordReset          PasswordReset[]
  Project                Project[]
  RecommendationFeedback RecommendationFeedback[]
  Session                Session[]
  SupportRequest         SupportRequest[]
  Task                   Task[]
  TaskTemplate           TaskTemplate[]
  UsageLedger            UsageLedger[]
}

enum FeatureFlagScope {
  GLOBAL
  USER
  ROLE
}

enum Plan {
  FREE
  PRO
}

enum PlanStatus {
  ACTIVE
  PAUSED
  SUSPENDED
}

enum TaskStatus {
  PENDING
  RUNNING
  SUCCEEDED
  FAILED
}

enum UsageType {
  GENERATION
  FOLLOWUP
  IMAGE
}

enum UserRole {
  USER
  ADMIN
  SUPERUSER
}
